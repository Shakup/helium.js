/*
 * helium.js - version 0.0.1 - 2015-10-11
 * An elegant framework to build rich applications
 * Author: SÃ©bastien Decamme <sebastien.decamme@gmail.com>
 * Homepage: https://github.com/Shakup/helium.js
 */

!function(a){"function"==typeof define&&define.amd?define("helium",["lea"],function(b){return a(b)}):a(Lea)}(function($){"use strict";function Template(){this.baseDir="/",this._loaderXHR=null,this._errorLoad=function(){},this._afterLoad=function(){},this._beforeLoad=function(){}}function Router(){this.routes={},this.mode="hash",this.basePath="/",this._404=function(){},this._before=function(){},this._after=function(){},this._currentRoute=null}function Data(){this._data={},this._incr=0,this._fnc={},this._actions={},this._options={},Object.observe(this._data,this._onChange.bind(this))}function Helium(){this.version="{{version}}",this.debug=!1}Template.prototype.errorLoad=function(a){return this._errorLoad=a,this},Template.prototype.beforeLoad=function(a){return this._beforeLoad=a,this},Template.prototype.afterLoad=function(a){return this._afterLoad=a,this},Template.prototype._extractCondition=function(a){var b,c=/(\@[^\=\s]+)(\=([^:]+)\?([^:]+)(\:(.+))?)?/,d={ref:null,compare:null,then:null,"else":null};return(b=c.exec(a))&&b.length>1?(b=this._cleanMatch(b),d.ref=b[1],b.length>2&&(d.compare=b[3],d.then=b[4],d["else"]=b[6]||null),d):null},Template.prototype._retrieve=function(a){if("string"!==$.type(a))return a;var b=a.substr(0,1);return"@"==b?He.data.get(a.substr(1)):a},Template.prototype._cleanMatch=function(a){return a.filter(function(a){return"undefined"!==$.type(a)})},Template.prototype._bindHtml=function(a){var b,c,d,e,f=this;return(d=this._extractCondition(a))?(b=d.compare?function(a,b,c,d){b=f._retrieve(b),d.compare=f._retrieve(d.compare),d.then=f._retrieve(d.then),d["else"]=f._retrieve(d["else"]);var e=b==d.compare?d.then:d["else"]?d["else"]:"";$('[he-bind="'+c+'"]').html(e)}:function(a,b,c){var d=f._retrieve(b);$('[he-bind="'+c+'"]').html(d)},c=d.ref.substr(1),e=He.data.bind(c,b,d),'he-bind="'+e+'"'):""},Template.prototype._bindAttr=function(a,b){var c,d,e,f,g,h=this;if(e=this._extractCondition(b),!e)return"";if(d=e.ref.substr(1),e.compare){var f=h._retrieve(d)==e.compare?e.then:e["else"]?e["else"]:"";c=function(a,b,c,d){b=h._retrieve(b),d.compare=h._retrieve(d.compare),d.then=h._retrieve(d.then),d["else"]=h._retrieve(d["else"]);var e=b==d.compare?d.then:d["else"]?d["else"]:"";$('[he-bind="'+c+'"]').attr(d.attr,e)}}else{var f=h._retrieve(d);c=function(a,b,c,d){var e=h._retrieve(b);$('[he-bind="'+c+'"]').attr(d.attr,e)}}return e.attr=a,g=He.data.bind(d,c,e),a+'="'+f+'" he-bind="'+g+'"'},Template.prototype.compile=function(a,b){return null==b&&(b={}),a=this.compileSingle(a),a=this.compileBind(a),a=this.compileLink(a),a=this.compileEach(a)},Template.prototype.compileEach=function(template){for(var reg=/{{\s*each\s+(@[\w\-_]+)\s+as\s+([\w\-_]+)\s*}}([\s\S]*){{\/each}}/g,match,data,alias,tpl,subTpl,coll,subReg,subMatch,subData,tplComp,exp,expVal;match=reg.exec(template);)tplComp="",data=match[1].substr(1),alias=match[2],tpl=match[3],coll=He.data.get(data),subReg=new RegExp("{{\\s*("+alias+"[^{\\s]*)\\s*}}","g"),"array"===$.type(coll)?(coll.forEach(function(item){for(subTpl=tpl;null!==(subMatch=subReg.exec(tpl));)exp=subMatch[1].replace(new RegExp("^("+alias+")","g"),"item"),expVal=eval(exp)||null,null!==expVal?subTpl=subTpl.replace(subMatch[0],eval(exp)):(subTpl=subTpl.replace(subMatch[0],""),He.log("[TEMPLATE] "+subMatch[0].replace(/[{|}|\s]/g,"")+" is not a valid data","error"));tplComp+=subTpl}),template=template.replace(match[0],tplComp)):template=template.replace(match[0],"");return template},Template.prototype.compileBind=function(a){for(var b,c=/{{bind\-html\s+(\@.+)?}}/g,d=/{{bind\-attr\s+([^\=\:\@]+)\=["'](.+)['"]}}/g;b=c.exec(a);)a=a.replace(b[0],this._bindHtml(b[1]));for(;b=d.exec(a);)a=a.replace(b[0],this._bindAttr(b[1],b[2]));return a},Template.prototype.compileSingle=function(a){for(var b,c,d,e=this,f=/{{\s*(\@.+)\s*}}/g;b=f.exec(a);)c=this._extractCondition(b[1]),c.ref=e._retrieve(c.ref),c.compare=e._retrieve(c.compare),c.then=e._retrieve(c.then),c["else"]=e._retrieve(c["else"]),d=c.compare?c.ref==c.compare?c.then:c["else"]?c["else"]:"":c.ref,a=a.replace(b[0],d);return a},Template.prototype.compileLink=function(a){function b(a,b,c){var d,e;null==b&&(b=""),null==c&&(c={}),d='<a href="'+He.router.getUrl(a)+'" he-link="'+a+'"';for(e in c)d+=" "+e+'="'+c[e]+'"';return d+=">"+b+"</a>"}function c(){for(var a,b=/(\S+)=["']?((?:.(?!["']?\s+(?:\S+)=|[>"']))+.)["']?/g,c=e.join(" "),d={};a=b.exec(c);)d[a[1]]=a[2];return d}for(var d,e,f,g=/{{link\s*(.+?)}}((.+?)({{\/link}}))?/g;d=g.exec(a);)e=d[1].trim().split(" "),f=e.shift(),a=1===d.length?a.replace(d[0],b(f)):a.replace(d[0],b(f,d[3],c(e.join(" "))));return a},Template.prototype.applyTags=function(a){$(a).find("[he-link]").click(function(a){a.preventDefault(),He.router.goTo($(this).attr("he-link"))})},Template.prototype.load=function(a,b){function c(a){function c(a){return a.replace(/[\._]*/g,"-")}var e,f=this;if(null!==d._loaderXHR&&d._loaderXHR.abort(),this._success=function(){},this._error=function(){},1==b&&"localStorage"in window){if(e=localStorage.getItem(c(a)))return d._afterLoad(e),this._success(e),this}else b=!1;return d._loaderXHR=$.get(d.baseDir+a).success(function(e){1==b&&localStorage.setItem(c(a),e),d._afterLoad(e),f._success(e)}).error(function(){d._errorLoad(),f._error()}),this}var d=this;return void 0==b&&(b=!1),c.prototype.success=function(a){return this._success=a,this},c.prototype.error=function(a){return this._error=a,this},this._beforeLoad(),new c(a)},Template.prototype.run=function(){var a=this;$("[he-template]").each(function(){{var b=$(this);$("#"+b.attr("he-template"))}b.html(a.compile($("#"+b.attr("he-template")).text())),a.applyTags(this)})},Router.prototype._stripSlashes=function(a){return a.toString().replace(/\/$/,"").replace(/^\//,"")},Router.prototype.before=function(a){return"function"==$.type(a)&&(this._before=a),this},Router.prototype.after=function(a){return"function"==$.type(a)&&(this._after=a),this},Router.prototype.currentPath=function(){var a="";return"history"===this.mode?(a=this._stripSlashes(decodeURI(location.pathname+location.search)),a=a.replace(/\?(.*)$/,""),a="/"!==this.basePath?a.replace(this.basePath,""):a):a=location.hash?location.hash.replace("#",""):"",this._stripSlashes(a)},Router.prototype.currentRoute=function(){return this._currentRoute},Router.prototype.exists=function(a){return a in this.routes},Router.prototype.register=function(a,b,c){return this.exists(a)?(He.log('[ROUTES] "'+a+'" already exists',"error"),!1):(this.routes[a]={path:"/"===this.path?"/":this._stripSlashes(b),action:c},this)},Router.prototype.register404=function(a){return"function"==$.type(a)&&(this._404=a),this},Router.prototype.goTo=function(a,b){return this.exists(a)?this._before(a)===!1?(He.log('[ROUTES] "'+a+'" cancelled',"warn"),this):(He.log('[ROUTES] Go to "'+a+'"'),"history"===this.mode?(history.pushState({name:a},a,this.getUrl(a)),this.execute(a,b||{})):location.hash="#/"+(""===this.routes[a].path?"":this.routes[a].path+"/"),this):(He.log('[ROUTES] "'+a+'" does not exists',"error"),!1)},Router.prototype.getUrl=function(a){if(!this.exists(a))return He.log('[ROUTES] "'+a+'" does not exists',"error"),!1;var b=location.protocol+"//"+location.host;return b+=location.port?":"+location.port:"",b+="/"===this.basePath?"":"/"+this._stripSlashes(this.basePath),b+="history"===this.mode?"/":"/#/",b+=""===this.routes[a].path?"":this.routes[a].path+"/"},Router.prototype.execute=function(a,b){return this.exists(a)?this._before(a)===!1?(He.log('[ROUTES] "'+a+'" cancelled',"warn"),this):(He.log('[ROUTES] Execute "'+a+'"'),"function"==$.type(this.routes[a].action)&&this.routes[a].action.call(null,this.routes[a],b||{}),He.data.set("route",a),this._currentRoute=a,this._after(a),this):(He.log('[ROUTES] "'+a+'" does not exists',"error"),!1)},Router.prototype.getNameByPath=function(a){var b,c;for(c in this.routes)if(b=this.routes[c],b.path===a)return c;return null},Router.prototype._onHashChange=function(){location.hash||(location.hash="#/");var a=this.getNameByPath(this.currentPath());null!==a&&this._before(a)!==!1?this.execute(a):this._trigger404()},Router.prototype._onPopState=function(a){null!==a.state&&"name"in a.state&&this._before(a.state.name)!==!1?this.execute(a.state.name):!a.state&&""===this.currentPath()&&this.exists("index")&&this._before("index")!==!1?this.execute("index"):this._trigger404()},Router.prototype._trigger404=function(){He.data.set("route",null),this._404()},Router.prototype.run=function(){var a;return this.basePath="/"!==this.basePath?this._stripSlashes(this.basePath)+"/":this.basePath,this.baseUrl=location.protocol+"//"+location.host+"/"+("/"!==this.basePath?this.basePath+"/":this.basePath),He.data.set("basePath",this.basePath),He.data.set("baseUrl",this.baseUrl),"history"===this.mode?(window.onpopstate=this._onPopState.bind(this),a=this.getNameByPath(this.currentPath()),null!==a&&this._before(a)!==!1?this.execute(a):this._trigger404()):(window.addEventListener("hashchange",this._onHashChange.bind(this),!1),this._onHashChange()),this},Data.prototype._onChange=function(a){var b=this;a.forEach(function(a){a.name in b._actions&&b._actions[a.name].forEach(function(c){b._fnc[c](a.name,a.object[a.name],c,b._options[c])})})},Data.prototype.set=function(a,b){return this._data[a]=b,this},Data.prototype.get=function(a){return a in this._data?this._data[a]:null},Data.prototype.exists=function(a){return a in this._data},Data.prototype.bind=function(a,b,c){var d;return d=this._incr++,this._actions[a]||(this._actions[a]=[]),this._actions[a].push(d),this._fnc[d]=b,this._options[d]=c||{},d},Data.prototype.unbind=function(a){var b,c;a=parseInt(a);for(b in this._actions)c=this._actions[b].indexOf(a),c>-1&&this._actions[b].splice(c,1);this._fnc[a]&&delete this._fnc[a],this._options[a]&&delete this._options[a]},Data.prototype.applyBind=function(a){var b,c;a=parseInt(a);for(b in this._actions)c=this._actions[b].indexOf(a),c>-1&&this._fnc[a](b,this.get(b),a,this._options[a])};var StopIteration=new Error("StopIteration");Helium.prototype.log=function(a,b){void 0===b&&(b="log"),this.debug===!0&&console[b](a)},Helium.prototype.router=new Router,Helium.prototype.template=new Template,Helium.prototype.data=new Data,Helium.prototype.run=function(){$.addMethod("render",function(a){return this.each(function(b){$(b).find("[he-bind]").each(function(){var a=$(this).attr("he-bind");He.data.unbind(a)}),$(b).html(He.template.compile(a)),He.template.applyTags(b),$(b).find("[he-bind]").each(function(){He.data.applyBind($(this).attr("he-bind"))})}),this}),this.router.run(),this.template.run(),console.info("Fueled by Helium v"+this.version)};var He=window.He=new Helium;return He});
//# sourceMappingURL=helium.min.js.map