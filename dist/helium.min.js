/*
 * helium.js - version 0.0.1 - 2015-11-09
 * An elegant framework to build rich applications
 * Author: SÃ©bastien Decamme <sebastien.decamme@gmail.com>
 * Homepage: https://github.com/Shakup/helium.js
 */

!function(a){"function"==typeof define&&define.amd?define("helium",["lea","handlebars"],function(b,c){return a(b,c)}):a(Lea,Handlebars)}(function(a,b){"use strict";function c(){this.baseDir="/",this._loaderXHR=null,this._errorLoad=function(){},this._afterLoad=function(){},this._beforeLoad=function(){}}function d(){this.routes={},this.mode="hash",this.basePath="",this._404=function(){},this._before=function(){},this._after=function(){},this._currentRoute=null}function e(){this._data={},this._incr=0,this._fnc={},this._actions={},this._options={},Object.observe(this._data,this._onChange.bind(this))}function f(){this.version="{{version}}",this.debug=!1}c.prototype.errorLoad=function(a){return this._errorLoad=a,this},c.prototype.beforeLoad=function(a){return this._beforeLoad=a,this},c.prototype.afterLoad=function(a){return this._afterLoad=a,this},c.prototype._retrieve=function(b){if("string"!==a.type(b))return b;var c=b.substr(0,1);return"@"==c?g.data.get(b.substr(1)):b},c.prototype._cleanMatch=function(b){return b.filter(function(b){return"undefined"!==a.type(b)})},c.prototype._extractCondition=function(a){var b,c=/(\@[^\=\s]+)(\=([^:]+)\?([^:]+)(\:(.+))?)?/,d={ref:null,compare:null,then:null,"else":null};return(b=c.exec(a))&&b.length>1?(b=this._cleanMatch(b),d.ref=b[1],b.length>2&&(d.compare=b[3],d.then=b[4],d["else"]=b[6]||null),d):null},c.prototype.applyTags=function(b){a(b).find("[he-link]").click(function(b){b.preventDefault(),g.router.goTo(a(this).attr("he-link"))})},c.prototype.load=function(b,c){function d(b){function d(a){return a.replace(/[\._]*/g,"-")}var f,g=this;if(null!==e._loaderXHR&&e._loaderXHR.abort(),this._success=function(){},this._error=function(){},1==c&&"localStorage"in window){if(f=localStorage.getItem(d(b)))return e._afterLoad(f),this._success(f),this}else c=!1;return e._loaderXHR=a.get(e.baseDir+b).success(function(a){1==c&&localStorage.setItem(d(b),a),e._afterLoad(a),g._success(a)}).error(function(){e._errorLoad(),g._error()}),this}var e=this;return void 0==c&&(c=!1),d.prototype.success=function(a){return this._success=a,this},d.prototype.error=function(a){return this._error=a,this},this._beforeLoad(),new d(b)},c.prototype._bindHtml=function(b){var c,d,e=this;return c=function(b,c,d){var f=e._retrieve(c);a('[he-bind="'+d+'"]').html(f)},d=g.data.bind(b,c),'he-bind="'+d+'"'},c.prototype._bindAttr=function(b,c){var d,e,f,h,i,j=this;if(f=this._extractCondition(c),!f)return"";if(e=f.ref.substr(1),f.compare){var h=j._retrieve(e)==f.compare?f.then:f["else"]?f["else"]:"";d=function(b,c,d,e){c=j._retrieve(c),e.compare=j._retrieve(e.compare),e.then=j._retrieve(e.then),e["else"]=j._retrieve(e["else"]);var f=c==e.compare?e.then:e["else"]?e["else"]:"";a('[he-bind="'+d+'"]').attr(e.attr,f)}}else{var h=j._retrieve(e);d=function(b,c,d,e){var f=j._retrieve(c);a('[he-bind="'+d+'"]').attr(e.attr,f)}}return f.attr=b,i=g.data.bind(e,d,f),b+'="'+h+'" he-bind="'+i+'"'},c.prototype._assignHelpers=function(){var a=this;b.registerHelper("link",function(a,b){var c=b.hash,a=a||"index",d='<a href="'+g.router.getUrl(a)+'" he-link="'+a+'"',e=b.fn(this);for(name in c)"route"!==name&&(d+=" "+name+'="'+c[name]+'"');return d+=">"+e+"</a>"}),b.registerHelper("bind-attr",function(c){var d,e,f=c.hash;for(d in f)break;return e=a._bindAttr(d,f[d]),new b.SafeString(e)}),b.registerHelper("bind-html",function(c){var d=a._bindHtml(c);return new b.SafeString(d)})},c.prototype.run=function(){var c=this;this._assignHelpers(),a("[he-template]").each(function(){{var d,e=a(this);a("#"+e.attr("he-template"))}d=b.compile(a("#"+e.attr("he-template")).text()),e.html(d(g.data._data)),c.applyTags(this)})},d.prototype._stripSlashes=function(a){return a.toString().replace(/\/$/,"").replace(/^\//,"")},d.prototype.before=function(b){return"function"==a.type(b)&&(this._before=b),this},d.prototype.after=function(b){return"function"==a.type(b)&&(this._after=b),this},d.prototype.currentPath=function(){var a="";return"history"===this.mode?(a=this._stripSlashes(decodeURI(location.pathname+location.search)),a=a.replace(/\?(.*)$/,""),a="/"!==this.basePath?a.replace(this.basePath,""):a):a=location.hash?location.hash.replace("#",""):"",this._stripSlashes(a)},d.prototype.currentRoute=function(){return this._currentRoute},d.prototype.exists=function(a){return a in this.routes},d.prototype.mount=function(a,b,c){return this.exists(a)?(g.log('[ROUTES] "'+a+'" already exists',"error"),!1):(this.routes[a]={path:"/"===this.path?"/":this._stripSlashes(b),action:c},this)},d.prototype.mount404=function(b){return"function"==a.type(b)&&(this._404=b),this},d.prototype.goTo=function(a,b){return this.exists(a)?this._before(a)===!1?(g.log('[ROUTES] "'+a+'" cancelled',"warn"),this):(g.log('[ROUTES] Go to "'+a+'"'),"history"===this.mode?(history.pushState({name:a},a,this.getUrl(a)),this.execute(a,b||{})):location.hash="#/"+(""===this.routes[a].path?"":this.routes[a].path+"/"),this):(g.log('[ROUTES] "'+a+'" does not exists',"error"),!1)},d.prototype.getUrl=function(a){if(!this.exists(a))return g.log('[ROUTES] "'+a+'" does not exists',"error"),!1;var b=location.protocol+"//"+location.host;return b+=location.port?":"+location.port:"",b+="/"===this.basePath?"":"/"+this._stripSlashes(this.basePath),b+="history"===this.mode?"/":"/#/",b+=""===this.routes[a].path?"":this.routes[a].path+"/"},d.prototype.execute=function(b,c){return this.exists(b)?this._before(b)===!1?(g.log('[ROUTES] "'+b+'" cancelled',"warn"),this):(g.log('[ROUTES] Execute "'+b+'"'),"function"==a.type(this.routes[b].action)&&this.routes[b].action.call(null,this.routes[b],c||{}),g.data.set("route",b),this._currentRoute=b,this._after(b),this):(g.log('[ROUTES] "'+b+'" does not exists',"error"),!1)},d.prototype.getNameByPath=function(a){var b,c;for(c in this.routes)if(b=this.routes[c],b.path===a)return c;return null},d.prototype._onHashChange=function(){location.hash||(location.hash="#/");var a=this.getNameByPath(this.currentPath());null!==a&&this._before(a)!==!1?this.execute(a):this._trigger404()},d.prototype._onPopState=function(a){null!==a.state&&"name"in a.state&&this._before(a.state.name)!==!1?this.execute(a.state.name):!a.state&&""===this.currentPath()&&this.exists("index")&&this._before("index")!==!1?this.execute("index"):this._trigger404()},d.prototype._trigger404=function(){g.data.set("route",null),this._404()},d.prototype.run=function(){var a;return this.basePath=this._stripSlashes(this.basePath||"")+"/",this.baseUrl=location.protocol+"//"+location.host+"/"+("/"===this.basePath?"":this.basePath),g.data.set("basePath",this.basePath),g.data.set("baseUrl",this.baseUrl),"history"===this.mode?(window.onpopstate=this._onPopState.bind(this),a=this.getNameByPath(this.currentPath()),null!==a&&this._before(a)!==!1?this.execute(a):this._trigger404()):(window.addEventListener("hashchange",this._onHashChange.bind(this),!1),this._onHashChange()),this},e.prototype._onChange=function(a){var b=this;a.forEach(function(a){a.name in b._actions&&b._actions[a.name].forEach(function(c){b._fnc[c](a.name,a.object[a.name],c,b._options[c])})})},e.prototype.set=function(a,b){return this._data[a]=b,this},e.prototype.get=function(a){return a in this._data?this._data[a]:null},e.prototype.exists=function(a){return a in this._data},e.prototype.bind=function(a,b,c){var d;return d=this._incr++,this._actions[a]||(this._actions[a]=[]),this._actions[a].push(d),this._fnc[d]=b,this._options[d]=c||{},d},e.prototype.unbind=function(a){var b,c;a=parseInt(a);for(b in this._actions)c=this._actions[b].indexOf(a),c>-1&&this._actions[b].splice(c,1);this._fnc[a]&&delete this._fnc[a],this._options[a]&&delete this._options[a]},e.prototype.applyBind=function(a){var b,c;a=parseInt(a);for(b in this._actions)c=this._actions[b].indexOf(a),c>-1&&this._fnc[a](b,this.get(b),a,this._options[a])};new Error("StopIteration");f.prototype.log=function(a,b){void 0===b&&(b="log"),this.debug===!0&&console[b](a)},f.prototype.router=new d,f.prototype.template=new c,f.prototype.data=new e,f.prototype.run=function(){a.addMethod("render",function(c){return this.each(function(d){var e=b.compile(c);a(d).html(e(g.data._data)),g.template.applyTags(d)}),this}),this.router.run(),this.template.run(),console.info("Fueled by Helium v"+this.version)};var g=window.He=new f;return g});
//# sourceMappingURL=helium.min.js.map